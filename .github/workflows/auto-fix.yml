name: Auto-Fix CI Failures

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    # No branch filter - runs on any branch including all PRs

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-fix:
    name: Auto-fix failed checks
    runs-on: ubuntu-latest
    # Only run if the CI workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install mini-agent-action
        run: pip install mini-agent-action

      - name: Get failed jobs
        id: failed-jobs
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const failedJobs = jobs.data.jobs
              .filter(job => job.conclusion === 'failure')
              .map(job => job.name.toLowerCase());

            console.log('Failed jobs:', failedJobs);

            return {
              fmt: failedJobs.some(name => name.includes('format')),
              clippy: failedJobs.some(name => name.includes('clippy')),
              test: failedJobs.some(name => name.includes('test') && !name.includes('integration'))
            };
          result-encoding: string

      - name: Parse failed jobs
        id: parse-jobs
        run: |
          echo "failed_jobs=${{ steps.failed-jobs.outputs.result }}" >> $GITHUB_OUTPUT
          echo "${{ steps.failed-jobs.outputs.result }}" | jq .

      - name: Fix formatting issues
        if: contains(steps.failed-jobs.outputs.result, '"fmt":true')
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running mini-agent-action to fix formatting issues..."
          mini-agent-action \
            --exec "cargo fmt --check" \
            --task "Fix all Rust formatting issues. Run 'cargo fmt' to format the code. You can verify with 'cargo fmt --check'." \
            --debug || echo "Mini-agent completed with exit code $?"

      - name: Fix clippy issues
        if: contains(steps.failed-jobs.outputs.result, '"clippy":true')
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running mini-agent-action to fix clippy issues..."
          mini-agent-action \
            --exec "cargo clippy -- -D warnings" \
            --task "Fix all clippy warnings. Analyze the clippy output and fix the issues in the source code. You will be validated against 'cargo clippy -- -D warnings'." \
            --debug || echo "Mini-agent completed with exit code $?"

      - name: Fix test failures
        if: contains(steps.failed-jobs.outputs.result, '"test":true')
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Running mini-agent-action to fix test failures..."
          mini-agent-action \
            --exec "cargo test" \
            --task "Fix all failing tests. Analyze the test output and fix the issues in the source code or tests. You will be validated against 'cargo test'." \
            --debug || echo "Mini-agent completed with exit code $?"

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create fix branch and PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch for the fix
          ORIGINAL_BRANCH="${{ github.event.workflow_run.head_branch }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FIX_BRANCH="auto-fix/${ORIGINAL_BRANCH//\//-}-${TIMESTAMP}"

          git checkout -b "$FIX_BRANCH"

          # Commit all changes
          git add -A
          git commit -m "Auto-fix CI failures from mini-agent-action

          This PR contains automated fixes for CI failures detected in $ORIGINAL_BRANCH.

          Fixes applied by mini-agent-action for:
          $(echo '${{ steps.failed-jobs.outputs.result }}' | jq -r 'to_entries | map(select(.value == true) | .key) | join(", ")')

          Source run: ${{ github.event.workflow_run.html_url }}"

          # Push the branch
          git push origin "$FIX_BRANCH"

          # Create draft PR
          gh pr create \
            --title "ðŸ¤– Auto-fix: CI failures in $ORIGINAL_BRANCH" \
            --body "## Automated Fix

          This PR contains automated fixes for CI failures detected in \`$ORIGINAL_BRANCH\`.

          ### Failed Checks Fixed
          $(echo '${{ steps.failed-jobs.outputs.result }}' | jq -r 'to_entries | map(select(.value == true) | "- " + .key) | join("\n")')

          ### Source Information
          - **Original Branch:** \`$ORIGINAL_BRANCH\`
          - **Failed Workflow Run:** ${{ github.event.workflow_run.html_url }}
          - **Commit:** ${{ github.event.workflow_run.head_sha }}

          ### Review Instructions
          This PR was automatically generated by mini-agent-action. Please review the changes carefully before merging.

          - Review the code changes for correctness
          - Verify that all CI checks pass
          - Merge if the fixes are appropriate, or close if you prefer to fix manually

          ---
          ðŸ¤– Generated by [mini-agent-action](https://github.com/r33drichards/mini-agent-action)" \
            --base "$ORIGINAL_BRANCH" \
            --head "$FIX_BRANCH" \
            --draft

      - name: Summary
        if: always()
        run: |
          echo "### Auto-Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Original Branch:** ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Jobs:** $(echo '${{ steps.failed-jobs.outputs.result }}' | jq -r 'to_entries | map(select(.value == true) | .key) | join(", ")')" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Made:** ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… A draft PR has been created with the automated fixes." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No changes were made by the auto-fix agent." >> $GITHUB_STEP_SUMMARY
          fi
